## The 4th Simons Cup Solution

### A. 盛放 (zime)

原题：

### B. 千言万雨 (violence)

原题：[[ARC115E] LEQ and NEQ](https://www.luogu.com.cn/problem/AT_arc115_e)

> $n\le 10^7$ 开 1 秒，这辈子有了。

对于 $n$ 比较小的情况可以直接线段树维护整体 dp，因为带 $\log$ 所以是不可能过的。

这种暴力做法是一定不能放过的！我们考虑正规组合做法。接下来会有一些比较炫酷的魔法。

容易想到容斥。考虑钦定有多少个位置 $x_i=x_{i+1}$，此时容易有一个 dp $f_{i,j}$ 表示前 $i$ 个位置里有 $j$ 个这样相等的位置，然而这个状态的转移显然需要维护前一项的取值，所以并不好做。直接做应该是 $\mathcal O(n^3)$ 到 $\mathcal O(n^4)$ 的。

我们发现，这样位置的数量和极长等值连续段的数量有关。至少 $i$ 个这样的位置意味着至多 $n-i$ 个连续段，并且这两个东西的钦定显然是可以一一对应的。所以我们只要把原序列钦定划分成 $n-i$ 个连续段就行了。所以我们直接考虑 dp：$f_{i,j}$ 表示前 $i$ 个位置里钦定了 $j$ 个连续段的方案数。我们发现这个状态是好做的，我们只要每次合并一个段当成连续段就行，因为它和前面的关系无所谓。于是这个东西变成简单的序列划分 dp，转移直接考虑合并连续段产生的贡献显然是这一段的 $\min$，所以：

$$
f_{i,j}\gets \sum\limits_{k=0}^{i-1} f_{k,j-1}\times \min\limits_{l=k+1}^i a_l
$$

从而答案就是 $ans_n=\sum\limits_{i=0}^{n-1} (-1)^i f_{n,n-i}$

直接做可以做到 $\mathcal O(n^4)$。使用 ST 表优化做到 $\mathcal O(n^3)$。这些都是 trivial 的优化。

可以发现状态是 $\mathcal O(n^2)$ 的，我们试图优化状态。注意到我们最后只关心状态的奇偶性，并且恰巧转移都是 $j\gets j-1$ 且系数与 $j$ 无关，所以我们可以直接把 $j$ 变成 $0/1$ 描述奇偶性。转移变成：

$$
f_{i,j}\gets \sum\limits_{k=0}^{i-1} f_{k,1-j}\times \min\limits_{l=k+1}^i a_l
$$

直接做可以做到 $\mathcal O(n^2)$。

熟悉历史和的朋友们都知道，我们这个东西长得像扫描线一样，所以后面那个 $\min$ 显然是一个单调栈的形式。数据结构学傻了就可以上线段树，做到 $\mathcal O(n\log n)$，可能还跑不过别人整体 dp。但是直接前缀和就可以小常数 $\mathcal O(n)$。

这个做法技巧性比较强。还有其他的一些线性做法可以通过这道题：建立小根笛卡尔树再树上 dp（这东西如果带 $\log$ 建树不知道能不能过）、拆暴力 dp 式子等，这些做法有了起点之后都比较简单，这里不再赘述了。事实上我本来是想强制在线把这些做法卡死的，但是这是 ~~ARC 的 E~~ T2，不是搬题人炫技的地方。

### C. 想念特效药 (rhythm)

原题：

喜欢我们通信题吗！


### D. 不止两票 (fearless)

原题：[UVA12267 Telephone Network](https://www.luogu.com.cn/problem/UVA12267)

简单的刻画题。~~不是阅读题~~

题目结合图片应该还是比较好懂的。看完题容易想到我们应该先观察刻画一波合法调用路径集合的形态，不然根本做不了。

感受一下，直接刻画一个合法的调用路径集合的形态是比较困难的，我们不妨考虑什么样的调用路径集合会不合法。由于每一层专家系统是递归定义的，我们不妨考虑第 $n$ 层到第 $n-1$ 层的连线的情况：

- $i$ 号节点上的调用和 $i+2^{n-1}$ 号节点上的调用（$i\in[0,2^{n-1})$）不能往同一个 $S(n-1)$ 走，不然两条调用路径就会同时占用一个节点。并且可以注意到，如果在这一层上分开了，之后它们就**独立**了。
- 对于同一条调用，输入输出两边必须往同一个 $S(n-1)$ 走，不然之后就连不起来了。
- 每个节点上的调用只能要么往上要么往下。

由于非常漂亮的独立性，可以发现在每一层的每一个专家系统都满足以上三条限制的调用路径集合将必然满足条件。

这种要么要么的限制启发我们使用图论的办法解决这个题。“反色连边，同色限制”，我们把不允许同时满足的条件之间连边，跑二分图染色取一种颜色出来就能得到一个方案。

考虑每一层开 $2^{n+2}$ 个点，分别表示输入侧向哪个开关，输出侧向哪个开关。连边比较显然。连完边之后跑二分图染色取一种颜色的当这一层的路径方案。然后可以发现向两个 $S(n-1)$ 走的调用路径形成了两个子问题，可以分治递归下去继续做。

做到 $S(0)$ 的时候就可以退出输出方案了。

无解当且仅当不是二分图或者调用在输入输出节点就会重叠。然而事实上，chenxia25 在原题题解证明了图中一定没有奇环，从而必然是二分图。

因为有 $n$ 层，每层总体来说都是 $2^n$ 个点，边数和点数同阶，所以总时间复杂度是 $\mathcal O(Tn2^n)$。

需要注意一下常数。

Bonus：这题的 UVA 数据远远没有开满……我本地测 $100$ 组满数据，我跑了 $9$ 秒，两篇题解分别跑了 $23$ 秒和 $38$ 秒。所以最后削成了 $20$ 组数据时限 $5$ 秒。